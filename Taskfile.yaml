version: '3'

# Reference: https://taskfile.dev/usage and tutorial video: https://www.youtube.com/watch?v=_-bpnCY3-FE

vars:
  GOCMD: go
  ENV: dev
  BUILD_DIR: build
  GOFLAGS: -race
  FLAGS: -v -x
  LDFLAGS: -ldflags="-w -s -X cmd.Version=1.0.0 -X cmd.CommitHash={{ .COMMIT_HASH }}"
  BENCH_CMD: '{{ .GOCMD }} test {{ .GOFLAGS }} -run=^$$ -bench=. -benchtime=10s ./...'
  PPROF_CMD: '{{ .GOCMD }} tool pprof -pdf {{ .BUILD_DIR }}/profile.out > {{ .BUILD_DIR }}/profile.pdf'

includes:
  build: ./environment/{{OS}}.yaml

tasks:
  build:
    label: build the app for {{ .GOOS }}/{{ .GOARCH }}
    cmds:
      - '{{ .GOBUILD }} {{ .GOCMD }} build -o {{ .BUILD_DIR }}/{{ .APP_NAME }} {{ .GOFLAGS }} {{ .FLAGS }} ./main.go'

  release:
    label: build the app for release
    cmds:
      - '{{ .GOBUILD }} {{ .GOCMD }} build -o {{ .BUILD_DIR }}/{{ .APP_NAME_DIST }} {{ .GOFLAGS }} {{ .LDFLAGS }} ./main.go'

  generated:
    - '{{ .GOBUILD }} {{ .GOCMD }} generate ./...'

  test:
    label: run tests
    cmds:
      - '{{ .GOCMD }} test -v ./...'

  vite-run:
    label: run vite dev server
    cmds:
      - 'cd vue-project && npm run dev -- --port 8080'

  vulncheck:
    label: run vulncheck
    cmds:
      # check if govulncheck is installed
      - 'if ! command -v govulncheck &> /dev/null; then go install golang.org/x/vuln/cmd/govulncheck@latest; fi'
      - 'govulncheck ./...'

  vet:
    label: run go vet
    cmds:
      - '{{ .GOCMD }} vet ./...'

  check-gofmt:
    label: Check gofmt passes
    cmds:
      - 'if [ -n "$($GOCMD fmt -l .)" ]; then echo "gofmt failed, please run $GOCMD fmt -w ."; exit 1; fi'

  benchmark:
    label: run benchmarks
    cmds:
      - '{{ .BENCH_CMD }}'

  profile:
    cmds:
      - 'mkdir -p {{ .BUILD_DIR }}'
      - '{{ .GOCMD }} test {{ .GOFLAGS }} -cpuprofile={{ .BUILD_DIR }}/cpu.out -memprofile={{ .BUILD_DIR }}/mem.out'
      - '{{ .GOCMD }} tool pprof -output={{ .BUILD_DIR }}/profile.out {{ .BUILD_DIR }}/{{ .PROJECT_NAME }} {{ .BUILD_DIR }}/cpu.out'
      - '{{ .PPROF_CMD }}'